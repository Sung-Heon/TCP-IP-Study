# TCP / IP 프로토콜 스택

![TCP/IP protocol stack](/jimin/notes/images/tcpstack.png)
[이미지 출처](https://taesun1114.tistory.com/entry/TCP-IP-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EC%8A%A4%ED%83%9D)

데이터 송수신 과정을 계층화한 것으로, '인터넷 기반의 효율적인 데이터 전송'이라는 문제를 여러 부분으로 쪼개서 각각의 이해 관계자를 구분하고 계층화한 결과물이다.

### LINK 계층

물리적인 연결을 표준화한 결과물로, LAN, WAN 과 같은 프로토콜을 정의하는 계층이다.

### IP 계층

목적지 주소로 데이터가 전송되기 위한 경로 선택을 담당하는 계층으로, 비연결지향적이며 전송되는 데이터를 신뢰할 수 없다는 특징이 있다.
<br />
IP는 하나의 패킷을 기반으로 설계되었기 때문에 여러 개의 데이터 패킷을 전송할 경우의 전송 순서를 보장할 수 없고, 데이터가 손실될 수도 있다.

### TCP / UDP 계층

IP 계층의 경로 정보를 바탕으로 데이터의 실제 송수신을 담당하는 전송(transport) 계층이다.
<br />
TCP는 IP를 기반으로 데이터가 잘 전송되었는지 확인하고 분실된 데이터를 재전송해줌으로써 IP에 신뢰성을 부여한다.

### APPLICATION 계층

프로그램의 성격에 따라 달라지는 클라이언트 - 서버 간의 데이터 송수신 규칙 등에 대한 구현을 담당하는 계층이다.
<br />
클라이언트와 서버 간의 데이터 송수신 시, 데이터의 끝은 어떻게 표현할 것인지 혹은 전송되는 데이터의 크기를 미리 알려줄 것인지 등에 대한 약속인 어플리케이션 프로토콜을 정의한다.

<br />

# TCP 흐름 제어

### 연결

TCP 소켓은 상대 소켓과의 연결 과정에서 다음과 같이 총 세 번의 대화를 주고 받는다. 이를 **Three-way handshaking**이라고 한다.
![TCP Connection](/jimin/notes/images/tcp_connection.png)
[이미지 출처](https://www.geeksforgeeks.org/tcp-3-way-handshake-process/)

1. 상대 소켓에게 [SYN] 메세지를 전달한다. SYN은 Synchronization의 준말로, 데이터 송수신에 앞서 전송되는 ‘동기화 메세지’라는 의미이다.
2. SYN 메세지를 전달받은 상대 소켓은 호스트 소켓에게 메세지를 전달받았음을 알리는 [SYN+ACK] 메세지를 전달한다. ACK는 Acknowledgment의 준말로, ‘응답 메세지’라는 의미이다. 이때 ACK값은 호스트 소켓으로부터 전달받은 패킷 번호 + 1의 값이고, SEQ는 상대 소켓이 보내는 패킷에 부여한 값이다.
3. 호스트 소켓은 상대 소켓에게 메세지를 전달받았음을 알리는 [ACK] 메세지를 전달한다.

### 데이터 송수신

TCP 소켓은 보내는 데이터 패킷에 번호를 부여해서 확인하는 작업을 거친다. 이를 통해 손실된 데이터의 확인 및 재전송이 가능하게 함으로써 손실없는 데이터의 전송을 보장한다.
![TCP data transfer](/jimin/notes/images/tcp_data_transfer.gif)
[이미지 출처](https://www.technologyuk.net/computing/computer-networks/internet/transport-layer-protocols.shtml#ID01)
<br />
위와 같이 패킷에 시퀀스 번호를 넣어 전송하면 상태 소켓은 다음에 받아야 할 시퀀스 번호를 담아 전송하는 방식으로 데이터 전송이 이루어진다.

이때 호스트 소켓은 시퀀스 넘버와 전송된 바이트를 같이 보내고 이를 전달받은 소켓은 다음 공식을 기준으로 ACK값을 설정한다.

`ACK = SEQ number + size of data + 1`

데이터 전송 과정에서 데이터가 손실된 경우, 호스트는 손실된 데이터 패킷을 받았다는 메세지를 상대로부터 받지 못했기 때문에 해당 패킷을 재전송한다. 이처럼 데이터 손실 시의 재전송에 대비하기 위해 TCP 소켓은 ACK 응답을 요구하는 패킷 전송 시에 타이머를 동작시키고, 이 타이머가 **time out** 되었을 경우 패킷을 재전송한다.

### 연결 종료

TCP 소켓은 연결 종료 과정에서 상대 소켓과의 총 네 번의 대화를 주고 받는다. 이를 **Four-way handshaking**이라고 한다.
![TCP close](/jimin/notes/images/tcp_close.jpeg)
[이미지 출처](https://sh-safer.tistory.com/146)

1. 상대 소켓에게 [FIN] 메세지(종료 메세지)를 보낸다.
2. 상대 소켓은 호스트 소켓에게 종료 메세지를 받았음을 알리는 응답 메세지를 보낸다.
3. 상대 소켓이 연결을 종료하고 호스트 소켓에게 종료했음을 알리는 종료 메세지를 보낸다.
4. 호스트 소켓이 종료 메세지를 받았음을 알리는 응답 메세지를 보내고 연결을 종료한다.

<br />

# TCP 소켓의 입출력 버퍼

> 송신된 데이터는 상대가 `recv()` 를 통해 읽어들이기 전까지 어디에 저장되는가?

A. 출력 버퍼와 입력 버퍼에 위치한다.

- `send()` 함수가 호출되면 데이터는 바로 전송되는 게 아니라, 출력 버퍼로 이동한다.
- `recv()` 함수가 호출되면 입력 버퍼에 저장된 데이터를 읽어들인다.
- 입출력 버퍼는 다음과 같은 특징이 있다.
  - 입출력 버퍼는 TCP 소켓 각각에 대해 존재하며, 소켓 생성 시 자동으로 생성된다.
  - 소켓을 닫아도 출력 버퍼에 남아 있는 데이터는 계속 전송된다.
  - 소켓을 닫으면 입력 버퍼에 남아 있던 데이터는 날아간다.
- TCP는 **슬라이딩 윈도우**라는 프로토콜을 통해 데이터 송신을 제어함으로써 입력 버퍼의 크기를 초과하는 데이터의 전송은 이루어지지 않는다.
